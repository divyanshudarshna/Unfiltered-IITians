generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// Enums
enum Role {
  STUDENT
  INSTRUCTOR
  ADMIN
}

enum DifficultyLevel {
  EASY
  MEDIUM
  HARD
}

enum PublishStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ContactStatus {
  PENDING
  RESOLVED
  DELETED
}

// ================== USER ==================
model User {
  id               String         @id @default(auto()) @map("_id") @db.ObjectId
  clerkUserId      String         @unique
  email            String         @unique
  name             String?
  role             Role           @default(STUDENT)
  password         String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Profile
  profileImageUrl  String?
  phoneNumber      String?
  dob              DateTime?
  fieldOfStudy     String?

  // Subscription
  isSubscribed     Boolean        @default(false)
  subscriptionKey  String?

  // Relations
  mockAttempts     MockAttempt[]
  enrollments      Enrollment[]
  subscriptions    Subscription[]
  courseProgress   CourseProgress[]
}

// ================== MOCKS ==================
model MockTest {
  id             String           @id @default(auto()) @map("_id") @db.ObjectId
  title          String
  description    String?
  price          Int              @default(0)
  actualPrice    Int?             // optional field for showing original price
  duration       Int?             // optional field for test duration (minutes, etc.)
  questions      Json             // include type, options, explanation, etc.
  tags           String[]         @default([])
  difficulty     DifficultyLevel  @default(EASY)
  status         PublishStatus    @default(DRAFT)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  // Relations
  attempts       MockAttempt[]
  subscriptions  Subscription[]
}

model MockAttempt {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  userId         String    @db.ObjectId
  mockTestId     String    @db.ObjectId
  answers        Json      @default("[]")
  score          Int?      @default(0)
  correctCount   Int?      @default(0)
  incorrectCount Int?      @default(0)
  unansweredCount Int?     @default(0)
  totalQuestions Int?      @default(0)
  percentage     Int?      @default(0)
  startedAt      DateTime  @default(now())
  submittedAt    DateTime?

  // Relations
  user           User      @relation(fields: [userId], references: [id])
  mockTest       MockTest  @relation(fields: [mockTestId], references: [id])
}

model Subscription {
  id              String     @id @default(auto()) @map("_id") @db.ObjectId
  userId          String     @db.ObjectId
  mockTestId      String?    @db.ObjectId
  courseId        String?    @db.ObjectId
  razorpayOrderId String    
  paid            Boolean    @default(false)
  createdAt       DateTime   @default(now())

  // Relations
  user     User      @relation(fields: [userId], references: [id])
  mockTest MockTest? @relation(fields: [mockTestId], references: [id])
  course   Course?   @relation(fields: [courseId], references: [id])
}

// ================== COURSES ==================
model Course {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  title          String
  description    String?
  price          Int          // Set price
  actualPrice    Int?         // Discounted price
  durationMonths Int
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  status         PublishStatus @default(DRAFT)

  // Relations
  enrollments    Enrollment[]
  contents       Content[]
  subscriptions  Subscription[]
  coupons        Coupon[]
  courseProgress CourseProgress[]
}

model Enrollment {
  id         String     @id @default(auto()) @map("_id") @db.ObjectId
  userId     String     @db.ObjectId
  courseId   String     @db.ObjectId
  enrolledAt DateTime   @default(now())

  user       User       @relation(fields: [userId], references: [id])
  course     Course     @relation(fields: [courseId], references: [id])
}

model Coupon {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  code        String   @unique
  discountPct Int      // % discount
  validTill   DateTime
  courseId    String   @db.ObjectId

  course      Course   @relation(fields: [courseId], references: [id])
}

model Content {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  order       Int
  courseId    String     @db.ObjectId

  course      Course     @relation(fields: [courseId], references: [id])
  lectures    Lecture[]
  quiz        Quiz?      @relation("ContentQuiz")
  courseProgress CourseProgress[]
}

model Lecture {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  videoUrl    String?
  pdfUrl      String?
  summary     String?   // Rich text/markdown
  order       Int
  contentId   String    @db.ObjectId

  content     Content   @relation(fields: [contentId], references: [id])
}

model Quiz {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  contentId   String    @unique @db.ObjectId   // ðŸ‘ˆ unique for 1â€“1 relation
  questions   Json      // store MCQs, options, correct answers, explanations

  content     Content   @relation("ContentQuiz", fields: [contentId], references: [id])
}

// ================== COURSE PROGRESS ==================
model CourseProgress {
  id                  String   @id @default(auto()) @map("_id") @db.ObjectId
  userId              String   @db.ObjectId
  courseId            String   @db.ObjectId
  contentId           String   @db.ObjectId
  completed           Boolean  @default(false)
  progress            Int      @default(0) // 0-100 percentage
  quizScore           Int?     // Score for quiz if content has one
  totalQuizQuestions  Int?
  attemptedQuestions  Json?    // Store the attempted quiz data
  lastAccessed        DateTime @default(now())
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  user                User     @relation(fields: [userId], references: [id])
  course              Course   @relation(fields: [courseId], references: [id])
  content             Content  @relation(fields: [contentId], references: [id])

  @@unique([userId, courseId, contentId])
}

// ================== TESTIMONIALS & CONTACT ==================
model Testimonial {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  role        String
  content     String
  image       String?
  rating      Float     @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model ContactUs {
  id        String        @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  email     String
  subject   String
  message   String
  status    ContactStatus @default(PENDING)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

// npx prisma db push
// npx prisma generate
// npx prisma studio
