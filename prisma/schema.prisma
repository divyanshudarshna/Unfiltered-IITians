generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// Enums
enum Role {
  STUDENT
  INSTRUCTOR
  ADMIN
}

enum DifficultyLevel {
  EASY
  MEDIUM
  HARD
}

enum PublishStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ContactStatus {
  PENDING
  RESOLVED
  DELETED
}

// ================== USER ==================
model User {
  id               String         @id @default(auto()) @map("_id") @db.ObjectId
  clerkUserId      String         @unique
  email            String         @unique
  name             String?
  role             Role           @default(STUDENT)
  password         String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Profile
  profileImageUrl  String?
  phoneNumber      String?
  dob              DateTime?
  fieldOfStudy     String?

  // Subscription
  isSubscribed     Boolean        @default(false)
  subscriptionKey  String?

  // Relations
  mockAttempts     MockAttempt[]
  enrollments      Enrollment[]
  subscriptions    Subscription[]
  courseProgress   CourseProgress[]

   // Added relations for announcements & feedback
  announcementsReceived AnnouncementRecipient[]
  feedbacks             CourseFeedback[]


  feedbackReplies    FeedbackReply[] // add this

  receivedFeedbackReplies FeedbackReplyRecipient[] // replies received by this student
  //need to add the relation for the sessions enrollments
  sessionEnrollments SessionEnrollment[]
}

// ================== MOCKS ==================
model MockTest {
  id             String           @id @default(auto()) @map("_id") @db.ObjectId
  title          String
  description    String?
  price          Int              @default(0)
  actualPrice    Int?
  duration       Int?
  questions      Json
  tags           String[]         @default([])
  difficulty     DifficultyLevel  @default(EASY)
  status         PublishStatus    @default(DRAFT)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  attempts       MockAttempt[]
  subscriptions  Subscription[]
}

model MockAttempt {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  userId         String    @db.ObjectId
  mockTestId     String    @db.ObjectId
  answers        Json      @default("[]")
  score          Int?      @default(0)
  correctCount   Int?      @default(0)
  incorrectCount Int?      @default(0)
  unansweredCount Int?     @default(0)
  totalQuestions Int?      @default(0)
  percentage     Int?      @default(0)
  startedAt      DateTime  @default(now())
  submittedAt    DateTime?

  user           User      @relation(fields: [userId], references: [id])
  mockTest       MockTest  @relation(fields: [mockTestId], references: [id])
}

model Subscription {
  id              String      @id @default(auto()) @map("_id") @db.ObjectId
  userId          String      @db.ObjectId
  mockTestId      String?     @db.ObjectId
  courseId        String?     @db.ObjectId
  mockBundleId    String?     @db.ObjectId   // ✅ NEW: Bundle subscription support
  razorpayOrderId String
  paid            Boolean     @default(false)
  expiresAt       DateTime?   // Subscription expiry date
  createdAt       DateTime    @default(now())

  // Relations
  user       User        @relation(fields: [userId], references: [id])
  mockTest   MockTest?   @relation(fields: [mockTestId], references: [id])
  course     Course?     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  mockBundle MockBundle? @relation(fields: [mockBundleId], references: [id])
}


// ================== COURSES ==================
model Course {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  title          String
  description    String?
  price          Int
  actualPrice    Int?
  durationMonths Int
  order          Int          @default(0) // ✅ NEW: Order field for course display sequence
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  status         PublishStatus @default(DRAFT)

  enrollments    Enrollment[]
  contents       Content[]
  subscriptions  Subscription[]
  coupons        Coupon[]
  courseProgress CourseProgress[]
  announcements  CourseAnnouncement[]

  
  feedbacks      CourseFeedback[]
    // Relation
  details      CourseDetail[]
}

model Enrollment {
  id         String     @id @default(auto()) @map("_id") @db.ObjectId
  userId     String     @db.ObjectId
  courseId   String     @db.ObjectId
  enrolledAt DateTime   @default(now())
  expiresAt  DateTime?  // Course access expiry date

  user       User       @relation(fields: [userId], references: [id])
  course     Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
}

model Coupon {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  code        String   @unique
  discountPct Int
  validTill   DateTime
  courseId    String   @db.ObjectId

  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
}

model Content {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  order       Int
  courseId    String     @db.ObjectId

  course      Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lectures    Lecture[]
  quiz        Quiz?      @relation("ContentQuiz")
  courseProgress CourseProgress[]
}

model Lecture {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  title           String
  videoUrl        String?   // Cloudinary video URL
  youtubeEmbedUrl String?   // YouTube embed URL (optional)
  pdfUrl          String?
  summary         String?
  order           Int
  contentId       String    @db.ObjectId

  content         Content   @relation(fields: [contentId], references: [id], onDelete: Cascade)
}

model Quiz {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  contentId   String    @unique @db.ObjectId
  questions   Json

  content     Content   @relation("ContentQuiz", fields: [contentId], references: [id], onDelete: Cascade)
}

// ================== COURSE PROGRESS ==================
model CourseProgress {
  id                  String   @id @default(auto()) @map("_id") @db.ObjectId
  userId              String   @db.ObjectId
  courseId            String   @db.ObjectId
  contentId           String   @db.ObjectId
  completed           Boolean  @default(false)
  progress            Int      @default(0)
  quizScore           Int?
  totalQuizQuestions  Int?
  attemptedQuestions  Json?
  lastAccessed        DateTime @default(now())
  createdAt           DateTime @default(now())
  updatedAt           DateTime @default(now())

  user                User     @relation(fields: [userId], references: [id])
  course              Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  content             Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId, contentId])
}

// ================== TESTIMONIALS & CONTACT ==================
model Testimonial {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  role        String
  content     String
  image       String?
  rating      Float     @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model StudentSuccessStory {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  role      String
  content   String
  image     String?   // Cloudinary image URL
  rating    Float     @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model ContactUs {
  id        String        @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  email     String
  subject   String
  message   String
  status    ContactStatus @default(PENDING)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

// ================== FAQ ==================
model FAQ {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  question  String
  answer    String
  category  String?   // free text
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  visible   Boolean   @default(true)
}

// ================== ANNOUNCEMENTS ==================
model CourseAnnouncement {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  courseId    String    @db.ObjectId
  title       String
  message     String
  sendEmail   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @default(now())

  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  recipients  AnnouncementRecipient[]

  @@index([courseId, createdAt(sort: Desc)])
}

model AnnouncementRecipient {
  id             String             @id @default(auto()) @map("_id") @db.ObjectId
  announcementId String             @db.ObjectId
  userId         String             @db.ObjectId
  read           Boolean            @default(false)
  deliveredEmail Boolean            @default(false)
  readAt         DateTime?

  announcement   CourseAnnouncement @relation(fields: [announcementId], references: [id])
  user           User               @relation(fields: [userId], references: [id])

  @@unique([announcementId, userId], name: "announcementId_userId")
}


// ================== FEEDBACK ==================
enum FeedbackStatus {
  PENDING
  RESOLVED
  DELETED
}

model CourseFeedback {
  id         String        @id @default(auto()) @map("_id") @db.ObjectId
  courseId   String        @db.ObjectId
  userId     String        @db.ObjectId
  content    String
  status     FeedbackStatus @default(PENDING)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @default(now())

  course     Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user       User          @relation(fields: [userId], references: [id])
  replies    FeedbackReply[] // Relation to admin replies
}

model FeedbackReply {
  id          String                   @id @default(auto()) @map("_id") @db.ObjectId
  feedbackId  String                   @db.ObjectId
  adminId     String                   @db.ObjectId
  message     String
  createdAt   DateTime                 @default(now())

  feedback    CourseFeedback           @relation(fields: [feedbackId], references: [id])
  admin       User                     @relation(fields: [adminId], references: [id])
  
  recipients  FeedbackReplyRecipient[] // back-relation to track who received/read this reply
}


model FeedbackReplyRecipient {
  id        String        @id @default(auto()) @map("_id") @db.ObjectId
  replyId   String        @db.ObjectId
  userId    String        @db.ObjectId
  read      Boolean       @default(false)
  readAt    DateTime?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @default(now()) @updatedAt

  reply     FeedbackReply @relation(fields: [replyId], references: [id])
  user      User          @relation(fields: [userId], references: [id])

  @@unique([replyId, userId], name: "replyId_userId")
}


// prisma/schema.prisma

model YoutubeCategory {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String   @unique
  desc      String?
  videos    YoutubeVideo[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model YoutubeVideo {
  id          String          @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  link        String          // YouTube iframe embed link
  categoryId  String          @db.ObjectId
  category    YoutubeCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}


model MaterialCategory {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  name      String     @unique
  desc      String?
  materials Material[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model Material {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  title      String
  slug       String?  @unique
  content    String?  // HTML content from text editor
  pdfUrl     String?  // URL to uploaded PDF (optional)
  youtubeLink String? // optional youtube (embed or watch)
  tags       String[] // array of tags (can be empty)
  order      Int?     // ordering within a category
  published  Boolean  @default(true)
  subjectId  String   @db.ObjectId
  subject    MaterialCategory @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}



model MockBundle {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  title           String
  description     String?
  mockIds         String[]      // ✅ Still stores mockTest IDs inside bundle
  basePrice       Int
  discountedPrice Int?
  status          PublishStatus @default(DRAFT)
  order          Int           @default(0) // ✅ NEW: Order field for bundle display sequence

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @default(now()) @updatedAt

  // ✅ New relation to subscriptions
  subscriptions   Subscription[]
}


// Add these enums to your existing enums section
enum SessionType {
  ONE_ON_ONE
  GROUP
}

enum SessionStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

// Add these models to your existing schema
model Session {
  id                  String         @id @default(auto()) @map("_id") @db.ObjectId
  title               String
  description         String?
  content             String?        // HTML content from text editor
  tags                String[]
  status              SessionStatus  @default(DRAFT)
  price               Float          @default(0)
  discountedPrice     Float?
  maxEnrollment       Int?           // null means unlimited
  type                SessionType
  duration            Int            // in minutes
  expiryDate          DateTime?
  order               Int            @default(0) // ✅ NEW: Order field for session display sequence
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  // Relations
  enrollments         SessionEnrollment[]

  @@index([status])
  @@index([expiryDate])
}

model SessionEnrollment {
  id                  String         @id @default(auto()) @map("_id") @db.ObjectId
  sessionId           String         @db.ObjectId
  userId              String         @db.ObjectId
  studentName         String         // Auto-filled from user table
  studentEmail        String         // Auto-filled from user table
  studentPhone        String         // Manually entered by user
  razorpayOrderId     String?
  razorpayPaymentId   String?
  paymentStatus       PaymentStatus  @default(PENDING)
  amountPaid          Float?
  enrolledAt          DateTime       @default(now())
  completedAt         DateTime?

  // Relations
  session             Session        @relation(fields: [sessionId], references: [id])
  user                User           @relation(fields: [userId], references: [id])

  @@unique([sessionId, userId])
  @@index([userId])
  @@index([sessionId])
  @@index([paymentStatus])
  @@index([enrolledAt])
}

model CourseDetail {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String

  courseId    String   @db.ObjectId
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SettingsUpload {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String   // Human readable title to recognize the file
  url         String   // Cloudinary URL
  fileType    String   // auto-detected: image, video, pdf, etc.
  purpose     String   // Usage purpose: logo, banner, course-material, etc.
  fileName    String   // Original file name
  publicId    String   // Cloudinary public ID for deletion
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("settings_uploads")
}

model Newsletter {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("newsletter")
}

// npx prisma db push
// npx prisma generate
// npx prisma studio
